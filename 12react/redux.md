## å‰è¨€ ğŸ¤”

- `React` æ˜¯å•å‘æ•°æ®æµï¼Œæ•°æ®é€šè¿‡ `props` ä»çˆ¶èŠ‚ç‚¹ä¼ é€’åˆ°å­èŠ‚ç‚¹ã€‚å¦‚æœé¡¶å±‚çš„æŸä¸ª `props` æ”¹å˜äº†ï¼Œ `React` ä¼šé‡æ–°æ¸²æŸ“æ‰€æœ‰çš„å­èŠ‚ç‚¹ã€‚æ³¨æ„âš ï¸ï¼š`props` æ˜¯åªè¯»çš„ï¼ˆå³ä¸å¯ä»¥ä½¿ç”¨ `this.props` ç›´æ¥ä¿®æ”¹ `props`ï¼‰ï¼Œå®ƒæ˜¯ç”¨äºåœ¨æ•´ä¸ªç»„ä»¶æ ‘ä¸­ä¼ é€’æ•°æ®å’Œé…ç½®ã€‚
- æ¯ä¸ªç»„ä»¶éƒ½æœ‰å±äºè‡ªå·±çš„ `state`ï¼Œ`state` å’Œ `props` çš„åŒºåˆ«åœ¨äº `state` åªå­˜åœ¨äºç»„ä»¶å†…éƒ¨ã€‚æ³¨æ„ âš ï¸ï¼šåªèƒ½ä»å½“å‰ç»„ä»¶è°ƒç”¨ `this.setState` æ–¹æ³•ä¿®æ”¹ `state` å€¼ï¼ˆä¸å¯ä»¥ç›´æ¥ä¿®æ”¹ `this.state`ï¼‰ã€‚
- å¯è§ï¼Œæ›´æ–°å­ç»„ä»¶æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯æ”¹å˜å­ç»„ä»¶è‡ªèº«çš„ `state` å€¼ï¼Œå¦ä¸€ç§åˆ™æ˜¯æ›´æ–°å­ç»„ä»¶ä»çˆ¶ç»„ä»¶æ¥æ”¶åˆ°çš„ `this.props`å€¼ä»è€Œè¾¾åˆ°æ›´æ–°ã€‚
- åœ¨ `React` é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¤§å¤šæ—¶å€™éœ€è¦è®©ç»„ä»¶å…±äº«æŸäº›æ•°æ®ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç»„ä»¶é—´ä¼ é€’æ•°æ®ï¼ˆé€šè¿‡ `props` ï¼‰çš„æ–¹å¼å®ç°æ•°æ®å…±äº«ï¼Œç„¶è€Œï¼Œå½“æ•°æ®éœ€è¦åœ¨éçˆ¶å­å…³ç³»çš„ç»„ä»¶é—´ä¼ é€’æ—¶æ“ä½œèµ·æ¥åˆ™å˜å¾—ååˆ†éº»çƒ¦ï¼Œè€Œä¸”å®¹æ˜“è®©ä»£ç çš„å¯è¯»æ€§é™ä½ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ `state`ï¼ˆçŠ¶æ€ï¼‰ç®¡ç†å·¥å…·ã€‚
- å¸¸è§çš„çŠ¶æ€ç®¡ç†å·¥å…·æœ‰ `redux`ï¼Œ`mobx`ã€‚ç”±äº `redux` æä¾›äº†çŠ¶æ€ç®¡ç†çš„æ•´ä¸ªæ¶æ„ï¼Œå¹¶æœ‰ç€æ¸…æ™°çš„çº¦æŸè§„åˆ™ï¼Œé€‚åˆåœ¨å¤§å‹å¤šäººå¼€å‘çš„åº”ç”¨ä¸­ä½¿ç”¨ã€‚æœ¬æ–‡ä»‹ç»çš„æ˜¯å¦‚ä½•åœ¨ `React` é¡¹ç›®ä¸­ä½¿ç”¨ `redux` è¿›è¡ŒçŠ¶æ€ç®¡ç†ã€‚

## è¿›å…¥æ­£é¢˜ ğŸ¥°

- æœ¬èŠ‚ä¸»è¦ä»‹ç» `redux` å’Œ `react-router` ç›¸å…³çš„åŸºç¡€çŸ¥è¯† ğŸ“–å’Œç›¸å…³é…ç½® ğŸ‘©ğŸ¾â€ğŸ’»ã€‚

### redux

#### åŸºæœ¬æ¦‚å¿µ

- ```
  redux
  ```

   é€‚ç”¨äºå¤šäº¤äº’ã€å¤šæ•°æ®æºçš„åœºæ™¯ã€‚ä»ç»„ä»¶è§’åº¦çœ‹ï¼Œå¦‚æœæˆ‘ä»¬çš„åº”ç”¨æœ‰ä»¥ä¸‹åœºæ™¯ï¼Œåˆ™å¯ä»¥è€ƒè™‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ 

  ```
  redux
  ```

  ï¼š

  > - æŸä¸ªç»„ä»¶çš„çŠ¶æ€ï¼Œéœ€è¦å…±äº«
  > - æŸä¸ªçŠ¶æ€éœ€è¦åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æ‹¿åˆ°
  > - ä¸€ä¸ªç»„ä»¶éœ€è¦æ”¹å˜å…¨å±€çŠ¶æ€
  > - ä¸€ä¸ªç»„ä»¶éœ€è¦æ”¹å˜å¦ä¸€ä¸ªç»„ä»¶çš„çŠ¶æ€

- å½“æˆ‘ä»¬çš„åº”ç”¨ç¬¦åˆä»¥ä¸Šæåˆ°çš„åœºæ™¯æ—¶ï¼Œè‹¥ä¸ä½¿ç”¨ `redux` æˆ–è€…å…¶ä»–çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œä¸æŒ‰ç…§ä¸€å®šè§„å¾‹å¤„ç†çŠ¶æ€çš„è¯»å†™ï¼Œé¡¹ç›®ä»£ç çš„å¯è¯»æ€§å°†å¤§å¤§é™ä½ï¼Œä¸åˆ©äºå›¢é˜Ÿå¼€å‘æ•ˆç‡çš„æå‡ã€‚

- å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ`redux` é€šè¿‡å°†æ‰€æœ‰çš„ `state` é›†ä¸­åˆ°ç»„ä»¶é¡¶éƒ¨ï¼Œèƒ½å¤Ÿçµæ´»çš„å°†æ‰€æœ‰ `state` å„å–æ‰€éœ€åœ°åˆ†å‘ç»™æ‰€æœ‰çš„ç»„ä»¶ã€‚

- ```
  redux
  ```

   çš„ä¸‰å¤§åŸåˆ™ï¼š

  - æ•´ä¸ªåº”ç”¨çš„ `state` éƒ½è¢«å­˜å‚¨åœ¨ä¸€æ£µ `object tree` ä¸­ï¼Œå¹¶ä¸” `object tree` åªå­˜åœ¨äºå”¯ä¸€çš„ `store` ä¸­ï¼ˆè¿™å¹¶ä¸æ„å‘³ä½¿ç”¨ `redux` å°±éœ€è¦å°†æ‰€æœ‰çš„ `state` å­˜åˆ° `redux` ä¸Šï¼Œç»„ä»¶è¿˜æ˜¯å¯ä»¥ç»´æŠ¤è‡ªèº«çš„ `state` ï¼‰ã€‚
  - `state` æ˜¯åªè¯»çš„ã€‚`state` çš„å˜åŒ–ï¼Œä¼šå¯¼è‡´è§†å›¾ï¼ˆ`view`ï¼‰çš„å˜åŒ–ã€‚ç”¨æˆ·æ¥è§¦ä¸åˆ° `state`ï¼Œåªèƒ½æ¥è§¦åˆ°è§†å›¾ï¼Œå”¯ä¸€æ”¹å˜ `state` çš„æ–¹å¼åˆ™æ˜¯åœ¨è§†å›¾ä¸­è§¦å‘`action`ã€‚`action`æ˜¯ä¸€ä¸ªç”¨äºæè¿°å·²å‘ç”Ÿäº‹ä»¶çš„æ™®é€šå¯¹è±¡ã€‚
  - ä½¿ç”¨ `reducers` æ¥æ‰§è¡Œ `state` çš„æ›´æ–°ã€‚ `reducers` æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œå®ƒæ¥å— `action` å’Œå½“å‰  `state` ä½œä¸ºå‚æ•°ï¼Œé€šè¿‡è®¡ç®—è¿”å›ä¸€ä¸ªæ–°çš„ `state` ï¼Œä»è€Œå®ç°è§†å›¾çš„æ›´æ–°ã€‚

![reduxå·¥ä½œæµç¨‹](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/13/16e638d85c974466~tplv-t2oaga2asx-watermark.awebp)

- å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ

  ```
  redux
  ```

   çš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

  - é¦–å…ˆï¼Œç”¨æˆ·åœ¨è§†å›¾ä¸­é€šè¿‡ `store.dispatch` æ–¹æ³•å‘å‡º `action`ã€‚
  - ç„¶åï¼Œ`store` è‡ªåŠ¨è°ƒç”¨ `reducers`ï¼Œå¹¶ä¸”ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼šå½“å‰ `state` å’Œæ”¶åˆ°çš„ `action`ã€‚`reducers` ä¼šè¿”å›æ–°çš„ `state` ã€‚
  - æœ€åï¼Œå½“`store` ç›‘å¬åˆ° `state` çš„å˜åŒ–ï¼Œå°±ä¼šè°ƒç”¨ç›‘å¬å‡½æ•°ï¼Œè§¦å‘è§†å›¾çš„é‡æ–°æ¸²æŸ“ã€‚


#### API

##### store

- `store` å°±æ˜¯ä¿å­˜æ•°æ®çš„åœ°æ–¹ï¼Œæ•´ä¸ªåº”ç”¨åªèƒ½æœ‰ä¸€ä¸ª `store`ã€‚
- `redux` æä¾› `createStore` è¿™ä¸ªå‡½æ•°ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ª `store` ä»¥å­˜æ”¾æ•´ä¸ªåº”ç”¨çš„ `state`ï¼š

```
import { createStore } from 'redux';
const store = createStore(reducer, [preloadedState], enhancer);
å¤åˆ¶ä»£ç 
```

- å¯ä»¥çœ‹åˆ°ï¼Œ`createStore` æ¥å— `reducer`ã€åˆå§‹ `state`ï¼ˆå¯é€‰ï¼‰å’Œå¢å¼ºå™¨ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ `store` å¯¹è±¡ã€‚

##### state

- `store` å¯¹è±¡åŒ…å«æ‰€æœ‰æ•°æ®ã€‚å¦‚æœæƒ³å¾—åˆ°æŸä¸ªæ—¶ç‚¹çš„æ•°æ®ï¼Œå°±è¦å¯¹ `store` ç”Ÿæˆå¿«ç…§ã€‚è¿™ç§æ—¶ç‚¹çš„æ•°æ®é›†åˆï¼Œå°±å«åš `state`ã€‚
- å¦‚æœè¦è·å–å½“å‰æ—¶åˆ»çš„ `state`ï¼Œå¯ä»¥é€šè¿‡ `store.getState()` æ–¹æ³•æ‹¿åˆ°ï¼š

```
import { createStore } from 'redux';
const store = createStore(reducer, [preloadedState], enhancer);

const state = store.getState();
å¤åˆ¶ä»£ç 
```

##### action

- `state` çš„å˜åŒ–ï¼Œä¼šå¯¼è‡´è§†å›¾çš„å˜åŒ–ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·æ¥è§¦ä¸åˆ° `state`ï¼Œåªèƒ½æ¥è§¦åˆ°è§†å›¾ã€‚æ‰€ä»¥ï¼Œ`state` çš„å˜åŒ–å¿…é¡»æ˜¯ç”±è§†å›¾å‘èµ·çš„ã€‚
- `action` å°±æ˜¯è§†å›¾å‘å‡ºçš„é€šçŸ¥ï¼Œé€šçŸ¥`store`æ­¤æ—¶çš„ `state` åº”è¯¥è¦å‘ç”Ÿå˜åŒ–äº†ã€‚
- `action` æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å…¶ä¸­çš„ `type` å±æ€§æ˜¯å¿…é¡»çš„ï¼Œè¡¨ç¤º `action` çš„åç§°ã€‚å…¶ä»–å±æ€§å¯ä»¥è‡ªç”±è®¾ç½®ï¼Œç¤¾åŒºæœ‰ä¸€ä¸ªè§„èŒƒå¯ä»¥å‚è€ƒï¼š

```
const action = {
  type: 'ADD_TODO',
  payload: 'Learn Redux' // å¯é€‰å±æ€§
};
å¤åˆ¶ä»£ç 
```

- ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªåç§°ä¸º `ADD_TODO` çš„ `action`ï¼Œå®ƒæºå¸¦çš„æ•°æ®ä¿¡æ¯æ˜¯ `Learn Redux`ã€‚

##### Action Creator

- `view` è¦å‘é€å¤šå°‘ç§æ¶ˆæ¯ï¼Œå°±ä¼šæœ‰å¤šå°‘ç§ `action`ï¼Œå¦‚æœéƒ½æ‰‹å†™ï¼Œä¼šå¾ˆéº»çƒ¦ã€‚
- å¯ä»¥å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥ç”Ÿæˆ `action`ï¼Œè¿™ä¸ªå‡½æ•°å°±ç§°ä½œ `Action Creator`ï¼Œå¦‚ä¸‹é¢ä»£ç ä¸­çš„ `addTodo` å‡½æ•°ï¼š

```
const ADD_TODO = 'æ·»åŠ  TODO';

function addTodo(text) {
  return {
    type: ADD_TODO,
    text
  }
}

const action = addTodo('Learn Redux');
å¤åˆ¶ä»£ç 
```

- `redux-actions` æ˜¯ä¸€ä¸ªå®ç”¨çš„åº“ï¼Œè®©ç¼–å†™ `redux` çŠ¶æ€ç®¡ç†å˜å¾—ç®€å•èµ·æ¥ã€‚è¯¥åº“æä¾›äº† `createAction` æ–¹æ³•ç”¨äºåˆ›å»ºåŠ¨ä½œåˆ›å»ºå™¨ï¼š

```
import { createAction } from "redux-actions"

export const INCREMENT = 'INCREMENT'
export const increment = createAction(INCREMENT)
å¤åˆ¶ä»£ç 
```

- ä¸Šè¾¹ä»£ç å®šä¹‰ä¸€ä¸ªåŠ¨ä½œ 

  ```
  INCREMENT
  ```

  , ç„¶åé€šè¿‡ 

  ```
  createAction
  ```

   åˆ›å»ºäº†å¯¹åº” 

  ```
  Action Creator
  ```

  ï¼š

  - è°ƒç”¨ `increment()` æ—¶å°±ä¼šè¿”å› `{ type: 'INCREMENT' }`
  - è°ƒç”¨`increment(10)`è¿”å› `{ type: 'INCREMENT', payload: 10 }`

##### store.dispatch()

- `store.dispatch()` æ˜¯è§†å›¾å‘å‡º `action` çš„å”¯ä¸€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª `action` å¯¹è±¡ä½œä¸ºå‚æ•°ï¼š

```
import { createStore } from 'redux';
const store = createStore(reducer, [preloadedState], enhancer);

store.dispatch({
  type: 'ADD_TODO',
  payload: 'Learn Redux'
});
å¤åˆ¶ä»£ç 
```

- ç»“åˆ `Action Creator`ï¼Œè¿™æ®µä»£ç å¯ä»¥æ”¹å†™å¦‚ä¸‹ï¼š

```
import { createStore } from 'redux';
import { createAction } from "redux-actions"
const store = createStore(reducer, [preloadedState], enhancer);

const ADD_TODO = 'ADD_TODO';
const add_todo = createAction('ADD_TODO'); // åˆ›å»º Action Creator

store.dispatch(add_todo('Learn Redux'));
å¤åˆ¶ä»£ç 
```

##### reducer

- `store` æ”¶åˆ° `action` ä»¥åï¼Œå¿…é¡»ç»™å‡ºä¸€ä¸ªæ–°çš„ `state`ï¼Œè¿™æ ·è§†å›¾æ‰ä¼šè¿›è¡Œæ›´æ–°ã€‚`state` çš„è®¡ç®—ï¼ˆæ›´æ–°ï¼‰è¿‡ç¨‹åˆ™æ˜¯é€šè¿‡ `reducer` å®ç°ã€‚
- `reducer` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å— `action` å’Œå½“å‰ `state` ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ `state`ï¼š

```
const reducer = function (state, action) {
  // ...
  return new_state;
};
å¤åˆ¶ä»£ç 
```

- ä¸ºäº†å®ç°è°ƒç”¨ `store.dispatch` æ–¹æ³•æ—¶è‡ªåŠ¨æ‰§è¡Œ `reducer` å‡½æ•°ï¼Œéœ€è¦åœ¨åˆ›å»º `store` æ—¶å°†å°† `reducer` ä¼ å…¥ `createStore` æ–¹æ³•ï¼š

```
import { createStore } from 'redux';
const reducer = function (state, action) {
  // ...
  return new_state;
};
const store = createStore(reducer);
å¤åˆ¶ä»£ç 
```

- ä¸Šé¢ä»£ç ä¸­ï¼Œ`createStore` æ–¹æ³•æ¥å— `reducer` ä½œä¸ºå‚æ•°ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ `store`ã€‚ä»¥åæ¯å½“è§†å›¾ä½¿ç”¨ `store.dispatch` å‘é€ç»™ `store` ä¸€ä¸ªæ–°çš„ `action`ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨ `reducer`å‡½æ•°ï¼Œå¾—åˆ°æ›´æ–°çš„ `state`ã€‚
- `redux-actions` æä¾›äº† `handleActions` æ–¹æ³•ç”¨äºå¤„ç†å¤šä¸ª `action`ï¼š

```
// ä½¿ç”¨æ–¹æ³•ï¼š
// handleActions(reducerMap, defaultState)

import { handleActions } from 'redux-actions';
const initialState = { 
  counter: 0 
};

const reducer = handleActions(
  {
    INCREMENT: (state, action) => ({
      counter: state.counter + action.payload
    }),
    DECREMENT: (state, action) => ({
      counter: state.counter - action.payload
    })
  },
  initialState,
);
å¤åˆ¶ä»£ç 
```

#### æ‹†åˆ†ã€åˆå¹¶ reducer

- å‰é¢æåˆ°ï¼Œåœ¨ä¸€ä¸ª `react` åº”ç”¨ä¸­åªèƒ½æœ‰ä¸€ä¸ª `store` ç”¨äºå­˜æ”¾åº”ç”¨çš„ `state`ã€‚ç»„ä»¶é€šè¿‡è°ƒç”¨ `action` å‡½æ•°ï¼Œä¼ é€’æ•°æ®åˆ° `reducer`ï¼Œ`reducer` æ ¹æ®æ•°æ®æ›´æ–°å¯¹åº”çš„ `state`ã€‚
- å¯¹äºå¤§å‹åº”ç”¨æ¥è¯´ï¼Œåº”ç”¨çš„ `state` å¿…ç„¶ååˆ†åºå¤§ï¼Œå¯¼è‡´ `reducer` çš„å¤æ‚åº¦ä¹Ÿéšç€å˜å¤§ã€‚

> æ‹†åˆ†

- åœ¨è¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ä»¥è€ƒè™‘å°† `reducer` æ‹†åˆ†æˆå¤šä¸ªå•ç‹¬çš„å‡½æ•°ï¼Œè®©æ¯ä¸ªå‡½æ•°è´Ÿè´£ç‹¬ç«‹ç®¡ç† `state` çš„ä¸€éƒ¨åˆ†ã€‚

> åˆå¹¶

- `redux` æä¾›äº† `combineReducers` è¾…åŠ©å‡½æ•°ï¼Œå¯å°†ç‹¬ç«‹åˆ†æ•£çš„ `reducer` åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„ `reducer` å‡½æ•°ï¼Œç„¶ååœ¨åˆ›å»º `store` æ—¶ä½œä¸º `createStore` çš„å‚æ•°ä¼ å…¥ã€‚
- æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼ŒæŠŠæ‰€æœ‰å­ `reducer` æ”¾åœ¨ä¸åŒçš„ç›®å½•ä¸‹ï¼Œç„¶ååœ¨åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ç»Ÿä¸€å¼•å…¥ï¼Œæœ€åå°†åˆå¹¶åçš„ `reducer` å¯¼å‡ºï¼š

```
// src/model/reducers.ts
import { combineReducers } from 'redux';
import UI from './UI/reducers';
import user from './user/reducers';
import content from './content/reducers';

const rootReducer = combineReducers({
  UI,
  user,
  content,
});

export default rootReducer;
å¤åˆ¶ä»£ç 
```

#### ä¸­é—´ä»¶åŠå¼‚æ­¥æ“ä½œ

- å¯¹ `redux` è€Œè¨€ï¼ŒåŒæ­¥æŒ‡çš„æ˜¯å½“è§†å›¾å‘å‡º `action` ä»¥åï¼Œ`reducer` ç«‹å³ç®—å‡º `state`ï¼ˆåŸå§‹çš„`redux`å·¥ä½œæµç¨‹ï¼‰ï¼Œè€Œå¼‚æ­¥æŒ‡çš„æ˜¯åœ¨ `action` å‘å‡ºä»¥åï¼Œè¿‡ä¸€æ®µæ—¶é—´å†æ‰§è¡Œ `reducer`ã€‚

- åŒæ­¥é€šå¸¸å‘ç”Ÿåœ¨åŸç”Ÿ `redux` çš„å·¥ä½œæµç¨‹ä¸­ï¼Œè€Œåœ¨å¤§å¤šæ•°å®é™…åœºæ™¯ä¸­ï¼Œæ›´å¤šçš„æ˜¯éœ€è¦å¼‚æ­¥æ“ä½œï¼š`action` å‘å‡ºä»¥åï¼Œåœ¨è¿›å…¥ `reducer` ä¹‹å‰éœ€è¦å…ˆå®Œæˆä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæ¯”å¦‚å‘é€ `ajax` è¯·æ±‚åæ‹¿åˆ°æ•°æ®åï¼Œå†è¿›å…¥ `reducer` æ‰§è¡Œè®¡ç®—å¹¶å¯¹ `state` è¿›è¡Œæ›´æ–°ã€‚

- æ˜¾ç„¶åŸç”Ÿçš„ `redux` æ˜¯ä¸æ”¯æŒå¼‚æ­¥æ“ä½œçš„ï¼Œè¿™å°±è¦ç”¨åˆ°æ–°çš„å·¥å…·â€”â€”ä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰æ¥å¤„ç†è¿™ç§ä¸šåŠ¡åœºæ™¯ã€‚ä»æœ¬è´¨ä¸Šæ¥è®²ä¸­é—´ä»¶æ˜¯å¯¹ `store.dispatch` æ–¹æ³•è¿›è¡Œäº†æ‹“å±•ã€‚

- ä¸­é—´ä»¶æä¾›ä½äº 

  ```
  action
  ```

   å‘èµ·ä¹‹åï¼Œåˆ°è¾¾ 

  ```
  reducer
  ```

   ä¹‹å‰çš„æ‰©å±•ç‚¹ï¼šå³é€šè¿‡ 

  ```
  store.dispatch
  ```

   æ–¹æ³•å‘å‡ºçš„ 

  ```
  action
  ```

   ä¼šä¾æ¬¡ç»è¿‡å„ä¸ªä¸­é—´ä»¶ï¼Œæœ€ç»ˆåˆ°è¾¾ 

  ```
  reducer
  ```

  ã€‚

  ![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6e6ec9807208b~tplv-t2oaga2asx-watermark.awebp)

- æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸­é—´ä»¶æ¥è¿›è¡Œæ—¥å¿—è®°å½•ï¼ˆ`redux-logger`ï¼‰ã€åˆ›å»ºå´©æºƒæŠ¥å‘Šï¼ˆè‡ªå·±å†™`crashReporter`ï¼‰ã€è°ƒç”¨å¼‚æ­¥æ¥å£ï¼ˆ`redux-saga`ï¼‰æˆ–è€…è·¯ç”±ï¼ˆ`connected-react-router`ï¼‰ç­‰æ“ä½œã€‚

- `redux` æä¾›äº†ä¸€ä¸ªåŸç”Ÿçš„ `applyMiddleware` æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†æ‰€æœ‰ä¸­é—´ä»¶ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œä¾æ¬¡æ‰§è¡Œã€‚å‡å¦‚è¦ä½¿ç”¨ `redux-logger` æ¥å®ç°æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š

```
import { applyMiddleware, createStore } from 'redux';
import createLogger from 'redux-logger';
const logger = createLogger();

const store = createStore(
  reducer,
  applyMiddleware(logger)
);
å¤åˆ¶ä»£ç 
```

- å¦‚æœæœ‰å¤šä¸ªä¸­é—´ä»¶ï¼Œåˆ™å°†ä¸­é—´ä»¶ä¾æ¬¡ä½œä¸ºå‚æ•°ä¼ å…¥ `applyMiddleware` æ–¹æ³•ä¸­ï¼š

```
import { applyMiddleware, createStore } from 'redux';
import createLogger from 'redux-logger';
import createSagaMiddleware from 'redux-saga';

const logger = createLogger(); // æ—¥å¿—è®°å½•
const sagaMiddleware = createSagaMiddleware(); // è°ƒç”¨å¼‚æ­¥æ¥å£

let middleware = [sagaMiddleware];
middleware.push(logger);

const store = createStore(
  reducer,
  // å¯ä¼ initial_state
  applyMiddleware(...middleware)
);
å¤åˆ¶ä»£ç 
```

- éœ€è¦æ³¨æ„âš ï¸çš„æ˜¯ï¼š
  - `createStore` æ–¹æ³•å¯ä»¥æ¥å—æ•´ä¸ªåº”ç”¨çš„åˆå§‹çŠ¶æ€ä½œä¸ºå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼Œè‹¥ä¼ å…¥åˆå§‹çŠ¶æ€ï¼Œ`applyMiddleware` åˆ™éœ€è¦ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ã€‚
  - æœ‰çš„ä¸­é—´ä»¶æœ‰æ¬¡åºè¦æ±‚ï¼Œä½¿ç”¨å‰è¦æŸ¥ä¸€ä¸‹æ–‡æ¡£ï¼ˆå¦‚ `redux-logger`ä¸€å®šè¦æ”¾åœ¨æœ€åï¼Œå¦åˆ™è¾“å‡ºç»“æœä¼šä¸æ­£ç¡®ï¼‰ã€‚

### react-redux

#### æ¦‚å¿µä»‹ç»

- å‰é¢å°èŠ‚ä»‹ç»çš„ `redux` æœ¬èº«æ˜¯ä¸€ä¸ªå¯ä»¥ç»“åˆ `react`ï¼Œ`vue`ï¼Œ`angular` ç”šè‡³æ˜¯åŸç”Ÿ `javaScript` åº”ç”¨ä½¿ç”¨çš„çŠ¶æ€åº“ã€‚

- ä¸ºäº†è®© `redux` å¸®æˆ‘ä»¬ç®¡ç† `react` åº”ç”¨çš„çŠ¶æ€ï¼Œéœ€è¦æŠŠ `redux` ä¸ `react` è¿æ¥ï¼Œå®˜æ–¹æä¾›äº†[ react-redux](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Freact-redux)åº“ï¼ˆè¿™ä¸ªåº“æ˜¯å¯ä»¥é€‰ç”¨çš„ï¼Œä¹Ÿå¯ä»¥åªç”¨`redux`ï¼‰ã€‚

- ```
  react-redux
  ```

   å°†æ‰€æœ‰ç»„ä»¶åˆ†æˆ UI ç»„ä»¶å’Œå®¹å™¨ç»„ä»¶ä¸¤å¤§ç±»ï¼š

  -  UI ç»„ä»¶åªè´Ÿè´£ UI çš„å‘ˆç°ï¼Œä¸å«æœ‰çŠ¶æ€ï¼ˆ`this.state`ï¼‰ï¼Œæ‰€æœ‰æ•°æ®éƒ½ç”± `this.props` æä¾›ï¼Œä¸”ä¸ä½¿ç”¨ä»»ä½• `redux` çš„ APIã€‚
  - å®¹å™¨ç»„ä»¶è´Ÿè´£ç®¡ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œå«æœ‰çŠ¶æ€ï¼ˆ`this.state`ï¼‰ï¼Œå¯ä½¿ç”¨ `redux` çš„ APIã€‚

- ç®€è€Œè¨€ä¹‹ï¼Œå®¹å™¨ç»„ä»¶ä½œä¸º  UI ç»„ä»¶çš„çˆ¶ç»„ä»¶ï¼Œè´Ÿè´£ä¸å¤–éƒ¨è¿›è¡Œé€šä¿¡ï¼Œå°†æ•°æ®é€šè¿‡ `props` ä¼ ç»™  UI ç»„ä»¶æ¸²æŸ“å‡ºè§†å›¾ã€‚

- `react-redux` è§„å®šï¼Œæ‰€æœ‰çš„ UI ç»„ä»¶éƒ½ç”±ç”¨æˆ·æä¾›ï¼Œå®¹å™¨ç»„ä»¶åˆ™æ˜¯ç”± `react-redux` è‡ªåŠ¨ç”Ÿæˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·è´Ÿè´£è§†è§‰å±‚ï¼ŒçŠ¶æ€ç®¡ç†åˆ™æ˜¯å…¨éƒ¨äº¤ç»™ `react-redux`ã€‚

#### API

##### connect æ–¹æ³•

- `react-redux` æä¾›äº† `connect` æ–¹æ³•ï¼Œç”¨äºå°† UI ç»„ä»¶ç”Ÿæˆå®¹å™¨ç»„ä»¶ï¼š

```
import { connect } from 'react-redux'

class Dashboard extends React.Component {
    ...
    // ç»„ä»¶å†…éƒ¨å¯ä»¥è·å– this.props.loading çš„å€¼
}

const mapStateToProps = (state) => {
  return {
    loading: state.loading,
  }
}

// å°†é€šè¿‡ connect æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆçš„å®¹å™¨ç»„ä»¶å¯¼å‡º
export default connect(
  mapStateToProps, // å¯é€‰
  // mapDispatchToProps, // å¯é€‰
)(Dashboard)
å¤åˆ¶ä»£ç 
```

- ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ

  ```
  connect
  ```

  æ–¹æ³•æ¥å—ä¸¤ä¸ªå¯é€‰å‚æ•°ç”¨äºå®šä¹‰å®¹å™¨ç»„ä»¶çš„ä¸šåŠ¡é€»è¾‘ï¼š

  - `mapStateToProps` è´Ÿè´£è¾“å…¥é€»è¾‘ï¼Œå³å°† `state` æ˜ å°„æˆä¼ å…¥ UI ç»„ä»¶çš„å‚æ•°ï¼ˆ`props`ï¼‰
  - `mapDispatchToProps` è´Ÿè´£è¾“å‡ºé€»è¾‘ï¼Œå³å°†ç”¨æˆ·å¯¹ UI ç»„ä»¶çš„æ“ä½œæ˜ å°„æˆ `action`

- æ³¨æ„âš ï¸ï¼šå½“

  ```
  connect
  ```

  æ–¹æ³•ä¸ä¼ å…¥ä»»ä½•å‚æ•°æ—¶ï¼Œç”Ÿæˆçš„å®¹å™¨ç»„ä»¶åªå¯ä»¥çœ‹ä½œæ˜¯å¯¹ UI ç»„ä»¶åšäº†ä¸€ä¸ªå•çº¯çš„åŒ…è£…ï¼Œä¸å«æœ‰ä»»ä½•çš„ä¸šåŠ¡é€»è¾‘ï¼š

  - çœç•¥ `mapStateToProps` å‚æ•°ï¼Œ UI ç»„ä»¶å°±ä¸ä¼šè®¢é˜… `store`ï¼Œå³ `store` çš„æ›´æ–°ä¸ä¼šå¼•èµ· UI ç»„ä»¶çš„æ›´æ–°ã€‚
  - çœç•¥ `mapDispatchToProps` å‚æ•°ï¼Œ UI ç»„ä»¶å°±ä¸ä¼šå°†ç”¨æˆ·çš„æ“ä½œå½“ä½œ `action` å‘é€æ•°æ®ç»™ `store`ï¼Œéœ€è¦åœ¨ç»„ä»¶ä¸­æ‰‹åŠ¨è°ƒç”¨ `store.dispatch` æ–¹æ³•ã€‚

> mapStateToProps

- `mapStateToProps` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å»ºç«‹ä¸€ä¸ªä» `state`å¯¹è±¡ï¼ˆå¤–éƒ¨ï¼‰åˆ° UI ç»„ä»¶ `props`å¯¹è±¡çš„æ˜ å°„å…³ç³»ã€‚è¯¥å‡½æ•°ä¼šè®¢é˜… æ•´ä¸ªåº”ç”¨çš„ `store`ï¼Œæ¯å½“ `state` æ›´æ–°çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œé‡æ–°è®¡ç®— UI ç»„ä»¶çš„å‚æ•°ï¼Œä»è€Œè§¦å‘ UI ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚
- `mapStateToProps` çš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯ `state` å¯¹è±¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼Œä»£è¡¨å®¹å™¨ç»„ä»¶çš„ `props` å¯¹è±¡ï¼š

```
// å®¹å™¨ç»„ä»¶çš„ä»£ç 
//    <Dashboard showType="SHOW_ALL">
//      All
//    </Dashboard>
const mapStateToProps = (state, ownProps) => {
  return {
    active: ownProps.showType === "SHOW_ALL",
    loading: state.loading,
  }
}
å¤åˆ¶ä»£ç 
```

- ä½¿ç”¨ `ownProps` ä½œä¸ºå‚æ•°åï¼Œå¦‚æœå®¹å™¨ç»„ä»¶çš„å‚æ•°å‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿä¼šå¼•å‘ UI ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

> mapDispatchToProps

- `mapDispatchToProps` æ˜¯ `connect` å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥å»ºç«‹ UI ç»„ä»¶çš„å‚æ•°åˆ° `store.dispatch` æ–¹æ³•çš„æ˜ å°„ã€‚
- ç”±äºåœ¨é¡¹ç›®ä¸­å¤§å¤šä½¿ç”¨ `mapDispatchToProps` æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œä¸è¿›è¡Œç»†è®²ã€‚å…³äº`mapStateToProps`ã€`mapDispatchToProps` å’Œ `connect` çš„æ›´è¯¦ç»†ç”¨æ³•è¯´æ˜å¯ä»¥æŸ¥çœ‹[æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Freact-redux)ã€‚

##### Provider ç»„ä»¶

- ä½¿ç”¨ `connect` æ–¹æ³•ç”Ÿæˆå®¹å™¨ç»„ä»¶ä»¥åï¼Œéœ€è¦è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ° `state` å¯¹è±¡ï¼Œæ‰èƒ½ç”Ÿæˆ  UI ç»„ä»¶ çš„å‚æ•°ã€‚
- `react-redux` æä¾›äº† `Provider` ç»„ä»¶ï¼Œå¯ä»¥è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ° `state`ï¼Œå…·ä½“ç”¨æ³•æ˜¯éœ€è¦ç”¨ `Provider` ç»„ä»¶åŒ…è£¹é¡¹ç›®çš„æ ¹ç»„ä»¶ï¼ˆå¦‚Appï¼‰ï¼Œä½¿å¾—æ ¹ç»„ä»¶æ‰€æœ‰çš„å­ç»„ä»¶éƒ½å¯ä»¥é»˜è®¤è·å–åˆ° `state` å¯¹è±¡ï¼š

```
import * as React from 'react';
import * as ReactDOM from 'react-dom';
import { Provider } from 'react-redux';
import App from './App';
import { store } from './store/configureStore';

ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById('root'),
);
å¤åˆ¶ä»£ç 
```

### react-router

- `react-router` æ˜¯å®Œæ•´çš„ `react` çš„è·¯ç”±è§£å†³æ–¹æ¡ˆï¼Œå®ƒä¿æŒ `UI` ä¸ `URL` çš„åŒæ­¥ã€‚åœ¨é¡¹ç›®ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ `v4` ç‰ˆã€‚

- éœ€è¦æ³¨æ„âš ï¸çš„æ˜¯ï¼Œåœ¨å¼€å‘ä¸­ä¸åº”è¯¥ç›´æ¥å®‰è£… 

  ```
  react-router
  ```

  ï¼Œå› ä¸ºğŸ‘‰ï¼šåœ¨ 

  ```
  v4
  ```

   ç‰ˆä¸­ 

  ```
  react-router
  ```

    è¢«åˆ’åˆ†ä¸ºä¸‰ä¸ªåŒ…ï¼š

  ```
  react-router
  ```

   ï¼Œ

  ```
  react-router-dom
  ```

   å’Œ 

  ```
  react-router-native
  ```

  ï¼Œå®ƒä»¬çš„åŒºåˆ«å¦‚ä¸‹ï¼š

  - `react-router`ï¼šæä¾›æ ¸å¿ƒçš„è·¯ç”±ç»„ä»¶å’Œå‡½æ•°ã€‚
  - `react-router-dom`ï¼šæä¾›æµè§ˆå™¨ä½¿ç”¨çš„è·¯ç”±ç»„ä»¶å’Œå‡½æ•°ã€‚
  - `react-router-native`ï¼šæä¾› `react-native` å¯¹åº”å¹³å°ä½¿ç”¨çš„è·¯ç”±ç»„ä»¶å’Œå‡½æ•°ã€‚

- å½“æˆ‘ä»¬çš„ 

  ```
  react
  ```

   åº”ç”¨åŒæ—¶ä½¿ç”¨äº† 

  ```
  react-router
  ```

   å’Œ 

  ```
  redux
  ```

  ï¼Œåˆ™å¯ä»¥å°†ä¸¤è€…è¿›è¡Œæ›´æ·±åº¦çš„æ•´åˆï¼Œå®ç°ï¼š

  - å°† `router` çš„æ•°æ®ä¸ `store` è¿›è¡ŒåŒæ­¥ï¼Œå¹¶ä¸”å¯ä»¥ä» `store`  è®¿é—® `router` æ•°æ®ï¼Œå¯ä½¿ç”¨ `this.props.dispatch` æ–¹æ³•å‘é€ `action`ã€‚
  - é€šè¿‡ `dispatch actions` å¯¼èˆªï¼Œä¸ªäººç†è§£æ˜¯å¯ä½¿ç”¨ `store.dispatch(push('routerName'))` åˆ‡æ¢è·¯ç”±ã€‚
  - åœ¨ `redux devtools` ä¸­æ”¯æŒè·¯ç”±æ”¹å˜çš„æ—¶é—´æ—…è¡Œè°ƒè¯•ã€‚

- æƒ³è¦å®ç°ä»¥ä¸Šçš„ç›®æ ‡ï¼Œåˆ™å¯ä»¥é€šè¿‡ 

  ```
  connected-react-router
  ```

   å’Œ 

  ```
  history
  ```

   ä¸¤ä¸ªåº“è¿›è¡Œå®ç°ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

  - åœ¨åˆ›å»º `store` çš„æ–‡ä»¶æ·»åŠ é…ç½®ï¼ŒåŒ…æ‹¬åˆ›å»º `history` å¯¹è±¡ã€ä½¿ç”¨ `connected-react-router` æä¾›çš„ `connectRouter` æ–¹æ³•å’Œ `history` å¯¹è±¡åˆ›å»º `root reducer`ã€ä½¿ç”¨ `connected-react-router`  æä¾›çš„ `routerMiddleware` ä¸­é—´ä»¶å’Œ `history` å¯¹è±¡å®ç° `dispatch actions` å¯¼èˆªã€‚

  ```
  import { connectRouter, routerMiddleware } from 'connected-react-router';
  import createHistory from 'history/createBrowserHistory';
  import { createStore, applyMiddleware } from 'redux';
  import { createLogger } from 'redux-logger';
  import createSagaMiddleware from 'redux-saga';
  import reducer from '../model/reducers';
  
  export const history = createHistory();
  
  const sagaMiddleware = createSagaMiddleware(); // è°ƒç”¨å¼‚æ­¥æ¥å£
  let middleware = [sagaMiddleware, routerMiddleware(history)];
  const logger = createLogger(); // æ—¥å¿—è®°å½•
  middleware.push(logger);
  
  const initialState = {};
  
  const store = createStore(
    connectRouter(history)(reducer),
    initialState,
    applyMiddleware(...middleware)
  );
  å¤åˆ¶ä»£ç 
  ```

  - åœ¨é¡¹ç›®å…¥å£æ–‡ä»¶ `index.js` ä¸­ä¸ºæ ¹ç»„ä»¶ä¸­æ·»åŠ é…ç½®ï¼ŒåŒ…æ‹¬ä½¿ç”¨ `connected-react-router` æä¾›çš„ `ConnectedRouter` ç»„ä»¶åŒ…è£¹è·¯ç”±ï¼Œå°†`ConnectedRouter` ç»„ä»¶ä½œä¸º`Provider`çš„å­ç»„ï¼Œå¹¶ä¸”å°†åœ¨ `store` ä¸­åˆ›å»ºçš„ `history` å¯¹è±¡å¼•å…¥ï¼Œå°†å…¶ä½œä¸º `props` å±æ€§ ä¼ å…¥`ConnectedRouter` ç»„ä»¶ï¼š

  ```
  import * as React from 'react';
  import * as ReactDOM from 'react-dom';
  import { Provider } from 'react-redux'
  import { ConnectedRouter } from 'connected-react-router'
  import App from './App'
  import rootSaga from './model/sagas';
  import { store, history } from './store/configureStore';
  
  ReactDOM.render(
    <Provider store={store}>
      <ConnectedRouter history={history}>
        <App />
      </ConnectedRouter>
    </Provider>,
    document.getElementById('root'),
  );
  å¤åˆ¶ä»£ç 
  ```

- ä»¥ä¸Šåˆ™å®Œæˆäº† `react-router` å’Œ `redux`çš„æ·±åº¦æ•´åˆ âœŒï¸ã€‚

## æ€»ç»“ ğŸ‘€

- æœ¬æ–‡ä»‹ç»çš„æ˜¯å¦‚ä½•åœ¨ `React` é¡¹ç›®ä¸­ä½¿ç”¨ `redux` è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œå¹¶å¯¹ç›¸å…³åŸºç¡€çŸ¥è¯†è¿›è¡Œä»‹ç»å’Œå±•ç¤ºäº†å®Œæ•´çš„ä»£ç ã€‚
- åœ¨è¿›è¡Œä¸šåŠ¡ä»£ç å¼€å‘å‰é€šå¸¸ä¼šå¯¹é¡¹ç›®è¿›è¡Œçš„ä¸€äº›ç‰¹æ®Šé…ç½®ï¼Œæœ‰åˆ©äºåæœŸçš„å·¥ç¨‹å¼€å‘ï¼Œå…·ä½“å†…å®¹å¯å‚è€ƒ ğŸ‘‰ï¼š[react + typescript é¡¹ç›®çš„å®šåˆ¶åŒ–è¿‡ç¨‹](https://juejin.cn/post/6844903922100862989#comment)ã€‚ 

### ä¸€ã€ä»€ä¹ˆæ˜¯Reduxçš„ä¸­é—´ä»¶ï¼Ÿ

æ‰€è°“ä¸­é—´ä»¶ï¼Œä¸€å®šæ˜¯å¤„äºä¸¤ä¸ªäº‹ç‰©çš„ä¸­é—´ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯Reduxä¸­é—´ä»¶å‘¢ï¼Ÿ

å›é¡¾ä¸€ä¸‹Reduxçš„å·¥ä½œæµç¨‹:

 Reduxçš„ä¸­é—´ä»¶ï¼Œå¤„äºActionå’ŒReducerä¹‹é—´ï¼Œå°†ä¸­é—´æŸä¸ªè¿‡ç¨‹æ‹¦æˆªä¸€ä¸‹ï¼Œè¿›è¡Œä¸€äº›å¤„ç†å†ç»§ç»­æ­£å¸¸æ‰§è¡Œï¼Œè¿™å°±æ˜¯ä¸­é—´ä»¶çš„åŠŸèƒ½ã€‚



é‚£ä¸ºä»€ä¹ˆè¦ç”¨åˆ°Reduxä¸­é—´ä»¶å‘¢ï¼Ÿ

å¯¹äºå¼‚æ­¥è¯·æ±‚çš„ä»£ç ï¼Œæˆ‘ä»¬æœ€å¥½å°†å®ƒä»¬æ”¾åˆ°Reduxä¸­é—´ä»¶é‡Œé¢ã€‚

å½“é¡¹ç›®å¤æ‚åˆ°ä¸€å®šè§„æ¨¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›è®©å„ä¸ªæ¨¡å—å°½å¯èƒ½çš„å®è¡Œå•ä¸€èŒè´£ï¼Œæ¯”å¦‚Reactä½œä¸ºä¸€ä¸ªè§†å›¾å±‚çš„æ¡†æ¶å°±åªè´Ÿè´£æ¸²æŸ“ï¼Œæ•°æ®çš„äº‹æƒ…ç»Ÿç»Ÿäº¤ç»™Reduxæ¥å¤„ç†ï¼Œæ­¤æ—¶ï¼Œç›¸å¯¹äºæŠŠå¼‚æ­¥è¯·æ±‚çš„Ajaxä»£ç æ”¾åˆ°å†™åˆ°ç»„ä»¶çš„componentDidMountç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œå…¶å®äº¤ç»™Reduxæ˜¯ä¸€ç§æ›´å¥½çš„é€‰æ‹©ã€‚å¦å¤–ï¼Œäº¤ç»™Redux,ä¸€æ–¹é¢èƒ½å¤Ÿåšåˆ°ä¸åŒç»„ä»¶çš„æ¥å£å¤ç”¨ï¼Œå¦ä¸€æ–¹é¢æ–¹ä¾¿äºæµ‹è¯•ï¼Œå•çº¯å»æµ‹è¯•ä¸€äº›å¼‚æ­¥ä»£ç æ¯”æµ‹è¯•ä¸€ä¸ªReactç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¼šæ›´åŠ å®¹æ˜“ã€‚ ç„¶è€ŒReduxé‡Œé¢dispatchçš„è¿‡ç¨‹ä¸­åªå…è®¸ä¼ é€’å¯¹è±¡ï¼Œè€Œä¸å…è®¸ä¼ é€’å‡½æ•°ã€‚äºæ˜¯ï¼Œredux-thunkä¾¿åº”è¿è€Œç”Ÿã€‚

### äºŒã€Redux-thunkå®ç°å¼‚æ­¥æ›´æ–°state

```
npm install redux-thunk --save
å¤åˆ¶ä»£ç 

```

é¦–å…ˆåœ¨é¡¹ç›®ä¸­å¯ç”¨redux-thunk

```
//src/store/index.js
import {createStore, applyMiddleware, compose} from 'redux';
import reducer from './reducer';
import thunk from 'redux-thunk'
import TodoSagas from './sagas'

//éœ€è¦åŒæ—¶æ¿€æ´»redux-devtoolsçš„chromeæ’ä»¶ï¼Œä¸‹é¢æ˜¯æ¿€æ´»ä»£ç 
//å…¼å®¹ä»£ç åœ¨redux-devtoolsçš„æ–‡æ¡£ä¸‹æ‹¿è¿‡æ¥ç…§ç€ç”¨å³å¯
const composeEnhancers =
  typeof window === 'object' &&
  window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ ?   
    window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({}) : compose;

const enhancer = composeEnhancers(applyMiddleware(thunk))
//åˆ›å»ºstore
const store = createStore(
  reducer,
  enhancer
)

export default store;
å¤åˆ¶ä»£ç 
//src/store/actionCreators.js
//ä»¥ä¸‹ä¸ºgetTodoListéƒ¨åˆ†
export const getTodoList = () => {
  return (dispatch) => {
    axios.get('xxx').then((res) => {
      const data = res.data.list
      //åˆ›å»ºaction
      const action = initListAction(data)
      //ç›¸å½“äºstore.dispatch
      //å…¶å®redux-thunkç»™å½“å‰è¿”å›å‡½æ•°ä¸­æ·»åŠ çš„ç¬¬ä¸€ä¸ªé»˜è®¤å‚æ•°å°±æ˜¯storeçš„dispatchæ–¹æ³•
      dispatch(action)
    })
  }
}
å¤åˆ¶ä»£ç 
  //App.js
  componentDidMount() {
    // axios.get('xxx').then((res) => {
    //   const data = res.data.data
    //   const action = initListAction(data)
    //   store.dispatch(action)
    // })
    //å°†ä»¥ä¸Šä»£ç æ”¾è¿›Reduxï¼Œæ•ˆæœç›¸åŒ
    const action = getTodoList()
    store.dispatch(action)
  }
å¤åˆ¶ä»£ç 

```

å› æ­¤ï¼Œredux-thunkå…¶å®æ˜¯æ‹¦æˆªäº†storeçš„dispatchæ–¹æ³•ï¼ŒReduxä¸­store.dispatchåŸæœ¬æ˜¯ä¸èƒ½ä¼ ä¸€ä¸ªå‡½æ•°è¿›å»çš„ï¼Œä½†æ˜¯redux-thunkè®©dispatchæ‹¥æœ‰çš„æ¥å—å‡½æ•°å‚æ•°çš„èƒ½åŠ›ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœdispatchæ–¹æ³•ä¸­ä¼ é€’çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆç›´æ¥æŒ‰ç…§æ­£å¸¸çš„Reduxå·¥ä½œæµæ¥è¿è¡Œï¼Œä½†å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆç›´æ¥æ‰§è¡Œå®ƒï¼Œå¹¶æŠŠstore.dispatchè¿™ä¸ªæ–¹æ³•å½“ä½œç¬¬ä¸€ä¸ªå‚æ•°ä¼ è¿›è¿™ä¸ªå‡½æ•°ã€‚

### ä¸‰ã€Redux-sagaå®ç°å¼‚æ­¥æ›´æ–°state

redux-sagaä¹Ÿæ˜¯Reduxä¸­å¤„ç†å¼‚æ­¥å‡½æ•°çš„ä¸­é—´ä»¶ã€‚

```
npm install redux-saga --save
å¤åˆ¶ä»£ç 

```

é¦–å…ˆåœ¨é¡¹ç›®ä¸­å¯åŠ¨redux-saga:

```
//src/store/index.js
import {createStore, applyMiddleware, compose} from 'redux';
import reducer from './reducer';
import createSagaMiddleware from 'redux-saga'
import TodoSagas from './sagas'
//åˆ›å»ºä¸­é—´ä»¶
const sagaMiddleware = createSagaMiddleware()
//éœ€è¦åŒæ—¶æ¿€æ´»redux-devtoolsçš„chromeæ’ä»¶ï¼Œä¸‹é¢æ˜¯æ¿€æ´»ä»£ç 
const composeEnhancers =
  typeof window === 'object' &&
  window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ ?   
    window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({}) : compose;

const enhancer = composeEnhancers(applyMiddleware(sagaMiddleware))
//åˆ›å»ºstore
const store = createStore(
  reducer,
  enhancer
)
//å¯åŠ¨ä¸­é—´ä»¶
sagaMiddleware.run(TodoSagas)

export default store;
å¤åˆ¶ä»£ç 
//sagas.js
import { takeEvery, put } from 'redux-saga/effects'
import { GET_INIT_LIST } from './actionTypes';
import { initListAction } from './actionCreators';
import axios from 'axios'
function* getInitList() {
  try {
    const res = yield axios.get('xxx')
    //æ‹¿åˆ°Ajaxæ•°æ®åï¼Œé€šè¿‡initListActionåˆ›å»ºactionå¯¹è±¡
    //æ³¨æ„: è¿™æ˜¯å¦ä¸€ä¸ªaction:INIT_LIST_ACTIONï¼Œç›´æ¥æ”¹å˜stateä¸­çš„listçš„å€¼
    const action = initListAction(res.data.list)
    //putç›¸å½“äºdispatchè¿™ä¸ªæ–°çš„action
    yield put(action)
  }catch(e) {
    console.log('ç½‘ç»œè¯·æ±‚å¤±è´¥')
  }
}
//å¯¼å‡ºçš„mySagaéœ€è¦å†™æˆä¸€ä¸ªGeneratorå‡½æ•°ï¼Œå¼‚æ­¥å¤„ç†å‡½æ•°getInitListä¹Ÿåº”æ˜¯Generatorå‡½æ•°
function* mySaga() {
  //æ‹¦æˆªGET_INIT_LISTè¿™ä¸ªaction
  yield takeEvery(GET_INIT_LIST, getInitList);
}

export default mySaga
å¤åˆ¶ä»£ç 
  //App.js
  componentDidMount() {
    const action = getInitList()
    store.dispatch(action)
  }
å¤åˆ¶ä»£ç 

```

æ‰€ä»¥ä½ èƒ½å¤Ÿçœ‹åˆ°ï¼Œåœ¨redux-sagaå½“ä¸­çš„å¤„ç†æ€è·¯æ˜¯: å…ˆæŠ›å‡ºä¸€ä¸ªç±»ä¼¼äºä¿¡å·ç¯çš„actionï¼Œredux-sagaçœ‹åˆ°äº†è¿™ä¸ªä¿¡å·ç¯ï¼Œæ‹¦æˆªä¸‹æ¥ï¼Œç„¶åæ‰§è¡Œå“åº”çš„å¼‚æ­¥å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå¼‚æ­¥å‡½æ•°æ‹¿åˆ°æ•°æ®åï¼Œæ‰§è¡ŒçœŸæ­£è¦æ›´æ–°stateçš„actionã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½œä¸ºä¿¡å·ç¯çš„actionåœ¨reducerä¸­å¹¶æ²¡æœ‰å…·ä½“å…³äºstateçš„é€»è¾‘ç¼–å†™ï¼Œè€Œä»…ä»…æ˜¯ç»™redux-sagaå‘ä¸€ä¸ªä¿¡å·è€Œå·²ã€‚ 

